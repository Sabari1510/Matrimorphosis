<app-navbar></app-navbar>

<div class="manage-page">
    <div class="container">
        <header class="page-header">
            <div>
                <h1>Manage Staff</h1>
                <p>Manage verified technicians and monitor their performance</p>
            </div>
            <button class="btn btn-primary" routerLink="/admin/dashboard">Back to Dashboard</button>
        </header>

        <!-- Filters Section -->
        <div class="filters-card">
            <div class="search-box">
                <input type="text" [(ngModel)]="searchQuery" (input)="applyFilters()"
                    placeholder="Search by name or Employee ID...">
                <span class="search-icon">üîç</span>
            </div>
            <div class="filters-grid">
                <select [(ngModel)]="selectedSpecialization" (change)="applyFilters()">
                    <option value="">All Specializations</option>
                    <option value="plumbing">Plumbing</option>
                    <option value="electrical">Electrical</option>
                    <option value="hvac">HVAC</option>
                    <option value="painting">Painting</option>
                    <option value="general">General</option>
                </select>
            </div>
        </div>

        <!-- Pending Technicians Section -->
        <div class="pending-section" *ngIf="pendingTechnicians.length > 0 && !isLoading">
            <h2 class="section-title">
                <span class="pending-badge">{{ pendingTechnicians.length }}</span>
                Pending Review
            </h2>
            <div class="pending-cards">
                <div class="pending-card" *ngFor="let tech of pendingTechnicians">
                    <div class="pending-header">
                        <div class="pending-avatar">
                            <img *ngIf="tech.photo" [src]="getMediaUrl(tech.photo)" [alt]="tech.name"
                                class="pending-photo">
                            <div *ngIf="!tech.photo" class="pending-initials">{{ getInitials(tech.name) }}</div>
                        </div>
                        <div class="pending-info">
                            <h4>{{ tech.name }}</h4>
                            <p>{{ tech.contact_info }}</p>
                        </div>
                    </div>
                    <div class="pending-details">
                        <div class="detail-row">
                            <span class="detail-label">Employee ID:</span>
                            <span class="detail-value">{{ tech.employee_id || 'Not provided' }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Specialization:</span>
                            <span class="detail-value specialization">{{ tech.specialization | titlecase }}</span>
                        </div>
                        <div class="detail-row" *ngIf="tech.phone">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value">{{ tech.phone }}</span>
                        </div>
                    </div>
                    <div class="pending-actions">
                        <button class="btn btn-approve" (click)="approveTechnician(tech.id)">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="20 6 9 17 4 12" />
                            </svg>
                            Approve
                        </button>
                        <button class="btn btn-reject" (click)="rejectTechnician(tech.id)">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12" />
                            </svg>
                            Reject
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="loading-container" *ngIf="isLoading">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading staff data...</p>
        </div>

        <div class="table-card" *ngIf="!isLoading">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Staff Member</th>
                            <th>Specialization</th>
                            <th>Assigned</th>
                            <th>Completed</th>
                            <th>Rating</th>
                            <th>Success Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let staff of filteredStaff">
                            <td>
                                <div class="staff-info-cell">
                                    <div class="staff-initials">{{ staff.initials }}</div>
                                    <div class="staff-meta">
                                        <div class="staff-name">{{ staff.name }}</div>
                                        <div class="staff-id">ID: {{ staff.employee_id || 'N/A' }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="specialization-tag" *ngIf="staff.specialization">
                                    {{ staff.specialization | titlecase }}
                                </span>
                                <span class="no-data" *ngIf="!staff.specialization">General</span>
                            </td>
                            <td>{{ staff.assigned }}</td>
                            <td>{{ staff.completed }}</td>
                            <td>
                                <div class="star-rating-sm" *ngIf="staff.avgRating > 0">
                                    <span class="star">‚òÖ</span> {{ staff.avgRating | number:'1.1-1' }}
                                </div>
                                <span class="no-data" *ngIf="staff.avgRating === 0">No ratings</span>
                            </td>
                            <td>
                                <div class="progress-bar-container">
                                    <div class="progress-bar"
                                        [style.width.%]="staff.assigned > 0 ? (staff.completed / staff.assigned * 100) : 0">
                                    </div>
                                    <span>{{ staff.assigned > 0 ? (staff.completed / staff.assigned * 100 |
                                        number:'1.0-0') : 0 }}%</span>
                                </div>
                            </td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn-icon view" [routerLink]="['/admin/technician-detail', staff.id]"
                                        title="View Details">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                            <circle cx="12" cy="12" r="3" />
                                        </svg>
                                    </button>
                                    <button class="btn-icon delete" (click)="deleteStaff(staff.id)"
                                        title="Delete Staff">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M18 6L6 18M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr *ngIf="filteredStaff.length === 0">
                            <td colspan="7" class="empty-state">No staff members found matching your search.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>