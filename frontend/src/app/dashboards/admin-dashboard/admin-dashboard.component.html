<app-navbar></app-navbar>

<div class="admin-dashboard">
    <div class="dashboard-container">
        <!-- Header Section -->
        <div class="dashboard-header">
            <div class="header-content">
                <div class="welcome-section">
                    <h1>Welcome, <span class="accent">{{ userName }}!</span></h1>
                    <p>Manage all maintenance requests and staff</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" routerLink="/admin/manage-requests">View Requests</button>
                    <button class="btn btn-primary" routerLink="/admin/manage-staff">View Staffs</button>
                </div>
            </div>
        </div>

        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon total">üìä</div>
                </div>
                <div class="metric-value">{{ stats.totalRequests }}</div>
                <div class="metric-label">Total Requests</div>
                <div class="metric-change positive">
                    <span>‚Üë 12%</span>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon pending">‚è≥</div>
                </div>
                <div class="metric-value">{{ stats.pendingRequests }}</div>
                <div class="metric-label">Pending</div>
                <div class="metric-change negative">
                    <span>‚Üì 8%</span>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon progress">üîß</div>
                </div>
                <div class="metric-value">{{ allRequests.length - stats.pendingRequests - stats.resolvedRequests
                    }}</div>
                <div class="metric-label">In Progress</div>
                <div class="metric-change positive">
                    <span>‚Üë 5%</span>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon completed">‚úÖ</div>
                </div>
                <div class="metric-value">{{ stats.resolvedRequests }}</div>
                <div class="metric-label">Completed</div>
                <div class="metric-change positive">
                    <span>‚Üë 15%</span>
                </div>
            </div>
        </div>

        <!-- Pending Technicians Section -->
        <div class="section-card" *ngIf="pendingTechnicians.length > 0">
            <div class="section-header">
                <h2 class="section-title">Pending Technician Approvals</h2>
                <span class="badge">{{ pendingTechnicians.length }}</span>
            </div>
            <div class="pending-technicians-grid">
                <div class="technician-card" *ngFor="let tech of pendingTechnicians">
                    <div class="tech-info">
                        <div class="tech-avatar">
                            <img *ngIf="tech.photo" [src]="getMediaUrl(tech.photo)" alt="{{tech.name}}">
                            <div *ngIf="!tech.photo" class="avatar-placeholder">{{ tech.name.charAt(0) }}</div>
                        </div>
                        <div class="tech-details">
                            <h3>{{ tech.name }}</h3>
                            <p class="tech-specialization">{{ tech.specialization | titlecase }}</p>
                            <p class="tech-contact">{{ tech.contact_info }}</p>
                            <p class="tech-employee-id">Employee ID: {{ tech.employee_id }}</p>
                        </div>
                    </div>
                    <div class="tech-actions">
                        <button class="btn btn-primary" [routerLink]="['/admin/technician-detail', tech.id]">
                            üëÅÔ∏è View Details
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Request Trends</h3>
                    <div class="chart-filter">
                        <button class="filter-btn active">Week</button>
                        <button class="filter-btn">Month</button>
                        <button class="filter-btn">Year</button>
                    </div>
                </div>
                <canvas id="requestsChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Status Distribution</h3>
                </div>
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <!-- Recent Requests Table -->
        <div class="table-section" id="requests-table">
            <div class="section-header">
                <h3 class="section-title">Recent Requests</h3>
                <button class="btn btn-secondary">View All</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Resident</th>
                            <th>Technician</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let request of recentRequests">
                            <td>#{{ request.id }}</td>
                            <td>{{ request.title }}</td>
                            <td>{{ request.residentName || request.resident?.name }}</td>
                            <td>{{ request.technicianName || request.technician?.name || 'Unassigned' }}</td>
                            <td>
                                <span class="priority-badge" [ngClass]="request.priority">
                                    {{ request.priority }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge" [ngClass]="request.status">
                                    {{ request.status }}
                                </span>
                            </td>
                            <td>{{ request.created_at | date:'short' }}</td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn-icon" (click)="viewRequestDetails(request)"
                                        title="View">üëÅÔ∏è</button>
                                    <button class="btn-icon" (click)="openAssignModal(request)"
                                        *ngIf="request.status !== 'Resolved'" title="Assign">üë§</button>
                                    <button class="btn-icon" (click)="deleteRequest($event, request.id)"
                                        title="Delete">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Staff Overview Section -->
        <div class="table-section staff-section" id="staff-table" style="margin-top: 30px;">
            <div class="section-header">
                <h3 class="section-title">Staff Overview & Performance</h3>
                <span class="badge">{{ staffPerformance.length }} Total Staff</span>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Staff Member</th>
                            <th>Specialization</th>
                            <th>Assigned</th>
                            <th>Completed</th>
                            <th>Rating</th>
                            <th>Success Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let staff of staffPerformance">
                            <td>
                                <div class="staff-info-cell">
                                    <div class="staff-initials">{{ staff.initials }}</div>
                                    <div class="staff-meta">
                                        <div class="staff-name">{{ staff.name }}</div>
                                        <div class="staff-role">{{ staff.role }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="specialization-tag" *ngIf="staff.specialization">
                                    {{ staff.specialization | titlecase }}
                                </span>
                                <span class="no-data" *ngIf="!staff.specialization">General</span>
                            </td>
                            <td>{{ staff.assigned }}</td>
                            <td>{{ staff.completed }}</td>
                            <td>
                                <div class="star-rating-sm" *ngIf="staff.avgRating && staff.avgRating > 0">
                                    <span class="star">‚òÖ</span> {{ staff.avgRating | number:'1.1-1' }}
                                </div>
                                <span class="no-data" *ngIf="!staff.avgRating || staff.avgRating === 0">No
                                    ratings</span>
                            </td>
                            <td>
                                <div class="progress-bar-container">
                                    <div class="progress-bar"
                                        [style.width.%]="staff.assigned > 0 ? (staff.completed / staff.assigned * 100) : 0">
                                    </div>
                                    <div class="progress-label">{{ staff.assigned > 0 ? (staff.completed /
                                        staff.assigned * 100 | number:'1.0-0') : 0 }}%</div>
                                </div>
                            </td>
                            <td>
                                <button class="btn-icon delete" (click)="handleDeleteStaff(staff.id)"
                                    title="Delete Staff">üóëÔ∏è</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div class="modal-overlay" *ngIf="showAssignModal">
        <div class="modal-card">
            <div class="modal-header">
                <h3>Assign Technician</h3>
                <button class="close-btn" (click)="closeAssignModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="request-summary" *ngIf="selectedRequest">
                    <p><strong>Request:</strong> {{ selectedRequest.title }}</p>
                    <p><strong>Category:</strong> <span class="badge">{{ selectedRequest.category | titlecase }}</span>
                    </p>
                </div>

                <div class="technician-list">
                    <h4>Available Technicians ({{ availableTechnicians.length }})</h4>
                    <p class="helper-text" *ngIf="selectedRequest">Showing technicians specialized in {{
                        selectedRequest.category | titlecase }}</p>

                    <div *ngIf="availableTechnicians.length === 0" class="empty-list">
                        <p>No verified technicians found with this specialization.</p>
                    </div>

                    <div class="tech-row" *ngFor="let tech of availableTechnicians">
                        <div class="tech-info">
                            <span class="tech-name">{{ tech.name }}</span>
                            <span class="tech-id">{{ tech.employee_id }}</span>
                        </div>
                        <button class="btn btn-primary btn-sm" (click)="assignTechnician(tech.id)">
                            Assign
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Detail Modal -->
    <app-request-modal *ngIf="selectedDetailRequest" [request]="selectedDetailRequest" [userRole]="'Admin'"
        [userId]="userId" (close)="closeDetailModal()" (updated)="loadData()">
    </app-request-modal>
</div>